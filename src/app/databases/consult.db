CREATE DATABASE `db_ielfa`

CREATE TABLE `Tbusuarios` (
  `id_usr` integer PRIMARY KEY AUTO_INCREMENT,
  `nombre_usr` varchar(100) NOT NULL,
  `login_usr` varchar(100) NOT NULL,
  `email_usr` varchar(50) NOT NULL,
  `password_usr` varchar(200) NOT NULL,
  `id_rol` integer NOT NULL,
  `created_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE `Tbroles` (
  `id_rol` integer PRIMARY KEY AUTO_INCREMENT,
  `nombre_rol` VARCHAR(50) DEFAULT 'Usuario'
);

ALTER TABLE `Tbusuarios`
ADD CONSTRAINT `FK_UsuariosRoles`
FOREIGN KEY (`id_rol`) REFERENCES Tbroles(`id_rol`);

insert into tbroles (nombre_rol) values('Usuario');

CREATE TABLE `Tbmiembros` (
  `id_mie` integer PRIMARY KEY AUTO_INCREMENT,
  `nombre_mie` varchar(100) NOT NULL,
  `cedula_mie` integer(10) NOT NULL,
  `direccion_mie` varchar(250) NOT NULL,
  `telefono_mie` varchar(20) NOT NULL,
  `fechanacimiento_mie` DATE NOT NULL,
  `sexo_mie` varchar(10) NOT NULL,
  `email_mie` varchar(50) NOT NULL,
  `tipo_mie` varchar(10) NOT NULL,  
  `created_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE `Tbeventos` (
 `codigo_eve` varchar(10) PRIMARY KEY,
  `nombre_eve` varchar(100) NOT NULL,
  `fecha_eve` date NOT NULL,
  `descripcion_eve` varchar(250) NOT NULL,
  `status_eve` varchar(10) DEFAULT 'Activo',
  `created_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE `Tbasistencia` (
  `id_asi` INTEGER PRIMARY KEY AUTO_INCREMENT,
  `id_mie` INTEGER NOT NULL,
  `codigo_eve` varchar(10) NOT NULL,
  `nombre_mie` VARCHAR(100) NOT NULL,
  `cedula_mie` INTEGER(10) NOT NULL,
  `fecha_asi` DATE NOT NULL,
  `created_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

ALTER TABLE `Tbasistencia`
ADD CONSTRAINT `FK_AsistenciaMiembros`
FOREIGN KEY (`id_mie`) REFERENCES Tbmiembros(`id_mie`);

ALTER TABLE `Tbasistencia`
ADD CONSTRAINT `fk_evento`
FOREIGN KEY (`codigo_eve`) REFERENCES `Tbeventos`(`codigo_eve`);

CREATE TABLE `configuracion` (
    `id` INT AUTO_INCREMENT PRIMARY KEY,
    `totalMiembros` int NOT NULL,
    `totalEventos` int NOT NULL
);

ALTER TABLE Tbasistencia
ADD COLUMN `fecha_eve` date NOT NULL
after cedula_mie

Amazon AWS
User: Administrator
Clave: FjEc)LwSlz(kCoa)Hi$?GX@%Q5Bu!ZKO

SELECT
    tbmiembros.id_mie,
    tbmiembros.nombre_mie,
    tbmiembros.cedula_mie,
    tbmiembros.tipo_mie,
    COUNT(tbasistencia.id_asi) AS total_eventos_asistidos,
    GROUP_CONCAT(tbeventos.codigo_eve ORDER BY tbeventos.fecha_eve SEPARATOR ' | ') AS eventos_asistidos
FROM
    tbeventos
JOIN
    tbasistencia ON tbeventos.codigo_eve = tbasistencia.codigo_eve
JOIN
    tbmiembros ON tbasistencia.id_mie = tbmiembros.id_mie
WHERE
    tbeventos.fecha_eve >= '2025-06-01'
    AND
    tbeventos.fecha_eve <= '2025-06-22'
GROUP BY
    tbmiembros.id_mie,
    tbmiembros.nombre_mie,
    tbmiembros.cedula_mie,
    tbmiembros.tipo_mie
ORDER BY
    total_eventos_asistidos DESC, nombre_mie;
    
    CREATE TABLE tbasistencia_borrador (
    id_borrador INT AUTO_INCREMENT PRIMARY KEY,
    codigo_eve VARCHAR(255) NOT NULL,
    id_mie INT NOT NULL,
    fecha_registro TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE KEY idx_evento_miembro (codigo_eve, id_mie)
);

En Postgress
Agregar la columna image_usr

-- Ejecuta esto una vez en tu base de datos
ALTER TABLE tbasistencia_borrador 
ADD CONSTRAINT unique_evento_miembro 
UNIQUE (codigo_eve, id_mie);

SELECT id_asi, id_mie, codigo_eve, fecha_asi,
       ROW_NUMBER() OVER (PARTITION BY id_mie, codigo_eve ORDER BY id_asi) as rn
FROM tbasistencia;

DELETE FROM tbasistencia t1
WHERE t1.id_asi IN (
    SELECT t2.id_asi
    FROM (
        SELECT id_asi,
               ROW_NUMBER() OVER (PARTITION BY id_mie, codigo_eve ORDER BY id_asi) as rn
        FROM tbasistencia
    ) t2
    WHERE t2.rn > 1
);


ALTER TABLE tbasistencia
ADD CONSTRAINT unique_miembro_evento UNIQUE (id_mie, codigo_eve);

ALTER TABLE tbmiembros
ADD CONSTRAINT unique_cedula UNIQUE (cedula_mie);

CREATE TABLE tbfamilias (
    id_fam SERIAL PRIMARY KEY,
    id_jefe_fam INT NOT NULL REFERENCES tbmiembros(id_mie) UNIQUE, 
    nombre_fam VARCHAR(255) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

ALTER TABLE tbmiembros
ADD COLUMN id_familia INT,
ADD COLUMN parentesco VARCHAR(50);

ALTER TABLE tbmiembros
ADD CONSTRAINT fk_familia
FOREIGN KEY (id_familia)
REFERENCES tbfamilias(id_fam);



